version: "3.9"
services:
  auth:
    image: aurokk/auth:23bc1f009003506f84fdba144ee8b4f0da78998d
    environment:
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/localhost.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: localhost
      ASPNETCORE_URLS: "http://+;https://+"
      IdentityUI__BaseUrl: "http://localhost:20020"
    ports:
      - "20000:443"
    volumes:
      - /Users/dk/.aspnet/https/localhost.pfx:/https/localhost.pfx
  identity-db:
    image: postgres
    restart: no
    environment:
      POSTGRES_DB: identity
      POSTGRES_USER: identity
      POSTGRES_PASSWORD: identity
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "20012:5432"
    volumes:
      - identity:/var/lib/postgresql/data
  identity-migrator:
    image: aurokk/identity:521950ae663e58074a00ffc364a5136f6cd32ecd
    depends_on:
      identity-db:
        condition: service_healthy
    restart: no
    environment:
      MODE: MIGRATOR
      Database__ConnectionString: "Host=identity-db;Port=5432;Username=identity;Password=identity;Database=identity;"
    volumes:
      - /Users/dk/.aspnet/https/localhost.pfx:/https/localhost.pfx
  identity:
    image: aurokk/identity:521950ae663e58074a00ffc364a5136f6cd32ecd
    depends_on:
      identity-migrator:
        condition: service_completed_successfully
    restart: no
    environment:
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/localhost.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: localhost
      ASPNETCORE_URLS: "http://+;https://+"
      MODE: WEB
      Auth__BaseUrl: "http://auth:80"
      Database__ConnectionString: "Host=identity-db;Port=5432;Username=identity;Password=identity;Database=identity;"
    ports:
      - "20010:443"
    volumes:
      - /Users/dk/.aspnet/https/localhost.pfx:/https/localhost.pfx
  identity-ui:
    image: aurokk/identity-ui:80abd24b8017fc7993f41c87285078941c649243
    environment:
      NEXT_PUBLIC_API_BASE_URL: "https://localhost:20010"
    ports:
      - "20020:3000"
  protected-resource-csharp:
    image: aurokk/protected-resource-csharp:c332953884da70e6a4b6600d8c97c20173b98bae
    environment:
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/localhost.pfx
      ASPNETCORE_Kestrel__Certificates__Default__Password: localhost
      ASPNETCORE_URLS: "http://+;https://+"
      Auth__BaseUrl: "http://auth:80"
      Auth__IssuerUrl__0: "https://auth:80"
      Auth__IssuerUrl__1: "https://localhost:20000"
    ports:
      - "20030:443"
    volumes:
      - /Users/dk/.aspnet/https/localhost.pfx:/https/localhost.pfx
volumes:
  identity: